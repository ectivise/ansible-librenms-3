---
- name: Configure LibreNMS
  template:
    src: config.php.j2
    dest: "{{ librenms_install_dir }}/config.php"
  notify: Restart PHP

- name: Set LibreNMS environment variables
  lineinfile:
    path: "{{ librenms_install_dir }}/.env"
    regex: "^{{ item.setting }}="
    line: "{{ item.setting }}={{ item.value }}"
  loop:
    - { setting: 'DB_HOST', value: '{{ librenms_database_host }}' }
    - { setting: 'DB_DATABASE', value: '{{ librenms_database_name }}' }
    - { setting: 'DB_USERNAME', value: '{{ librenms_database_user }}' }
    - { setting: 'DB_PASSWORD', value: '{{ librenms_database_password }}' }
    - { setting: 'LIBRENMS_USER', value: '{{ librenms_user }}' }

- name: Configure snmpd
  template:
    src: snmpd.conf.j2
    dest: /etc/snmp/snmpd.conf
  notify: Restart snmpd

- name: Download snmpd distro detection script
  get_url:
    url: https://raw.githubusercontent.com/librenms/librenms-agent/master/snmp/distro
    dest: /usr/bin/distro
    mode: "0755"

- name: Configure cron
  copy:
    src: "{{ librenms_install_dir }}/librenms.nonroot.cron"
    dest: /etc/cron.d/librenms
    remote_src: yes

- name: Configure logrotate
  copy:
    src: "{{ librenms_install_dir }}/misc/librenms.logrotate"
    dest: /etc/logrotate.d/librenms
    remote_src: yes
